ServerName localhost

<VirtualHost _default_:80>

# Caching of static assests
# https://stackoverflow.com/questions/896974/apache-is-not-sending-304-response-if-mod-deflate-and-addoutputfilterbytype-is
# https://serverfault.com/questions/636976/why-does-apache-send-200-ok-while-last-modified-matches-if-modified-since

SetEnvIf           If-None-Match "-gzip\"$" request_etag=gzip
RequestHeader edit If-None-Match "(.+)-gzip\"$" "$1\""
Header edit        ETag     "(.+(?<!-gzip))\"$" "$1-gzip\"" "expr=reqenv('request_etag') == 'gzip' || resp('Content-Encoding') == 'gzip'"

#Ignoring invalid headers and keepalive settings per nuxeo doc here: https://doc.nuxeo.com/nxdoc/http-and-https-reverse-proxy-configuration/#bandwidth-and-transactions-optimizations
KeepAlive On    
KeepAliveTimeout 300
MaxKeepAliveRequests 100

# Cache CSS and JS for one month. New releases change names anyway
<filesMatch ".(css|js)$">
    Header set Cache-Control "max-age=2628000, public"
</filesMatch>

# Logs
# LogFormat "%h %l %u %t \"%r\" %>s %b" common
# CustomLog /var/log/apache2/nuxeo_access.log common
# ErrorLog /var/log/apache2/nuxeo_error.log

DocumentRoot /app

<IfModule mod_rewrite.c>

Options +FollowSymLinks

RewriteEngine On

# HTTP to HTTPS redirect
RewriteCond %{HTTP:X-Forwarded-Proto} ^http$
RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Proxy NUXEO requests
RewriteRule ^/nuxeo/(.*)$ http://localhost:8080/nuxeo/$1 [P]

# For IE 11, serve from legacy
RewriteCond %{HTTP_USER_AGENT} ^.*(Trident/7|Trident/6).*$ [NC]
RewriteRule ^(.*)/assets/(.*)$ /legacy/assets/$2 [NC,L]

# Serve /assets/ requests from filesystem
RewriteRule ^(.*)/assets/(.*)$ /evergreen/assets/$2 [NC,L]

# Rewrite OLD urls
RewriteRule ^/(en|fr)/home($|/) / [R=301,L]
RewriteRule ^/(en|fr)/privacy($|/) /content/privacy [R=301,L]
RewriteRule ^/(en|fr)($|/)$ / [R=301,L]
RewriteRule ^/(en|fr)/about($|/) /content/get-started [R=301,L]
RewriteRule ^/(en|fr)/conditions($|/) /content/conditions [R=301,L]
RewriteRule ^/(en|fr)/disclaimer($|/) /content/disclaimer [R=301,L]
RewriteRule ^/(en|fr)/apps($|/) /content/apps [R=301,L]
RewriteRule ^/get-involved($|/) /content/get-involved [R=301,L]
RewriteRule ^/tutor($|/) http://tutor.firstvoices.com/LMSWrapperWeb/FirstVoicesLogin.aspx [R=301,L]
RewriteRule ^/builderDemo($|/) http://builder.firstvoices.com/published/launch/1351/Course2792/Launch.html [R=301,L]
RewriteRule ^/(en|fr)/enter-(colouring-pictures|)($|/) /kids [R=301,L]
RewriteRule ^/(en|fr)/games($|/) /kids [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(about)($|/) /t/sections/$2/learn [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(alphabet)($|/) /t/sections/$2/learn_alphabet [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/apps($|/) /sections/$2 [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(art-gallery|community-slide-show)($|/) /t/sections/$2/gallery [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(games)($|/) /t/sections/$2/play [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(phrase-books)($|/) /t/sections/$2/learn_phrases [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(songs)($|/) /t/sections/$2/learn_songs [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(stories)($|/) /t/sections/$2/learn_stories [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)/(words)($|/) /t/sections/$2/learn_words [R=301,L]
RewriteRule ^/sections/apps/ /content/apps [R=301,L]
RewriteRule ^/(en|fr)/([^/]+)($|/) /sections/$2 [R=301,L]
RewriteRule ^/(explore|kids)/FV/(Workspaces|sections)/Data/(.*)/(.*)/(.*)/play/hangman($|/) /$1/FV/$2/Data/$3/$4/$5/play/parachute [R=301,L]

# SPA for other requests: For IE 11, serve from legacy
RewriteCond %{HTTP_USER_AGENT} ^.*(Trident/7|Trident/6).*$ [NC]
RewriteRule (.*) /legacy/index.html [NC,L]

# SPA for all other requests
RewriteRule (.*) /evergreen/index.html [NC,L]

</IfModule>

<Directory /app>
    AllowOverride All
    Require all granted
</Directory>

</VirtualHost>
